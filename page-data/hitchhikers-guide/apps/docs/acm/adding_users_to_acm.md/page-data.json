{"componentChunkName":"component---src-templates-markdown-remark-js","path":"/hitchhikers-guide/apps/docs/acm/adding_users_to_acm.md","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"markdownRemark":{"id":"6984afa3-8e96-5acc-abe1-7c9703bd9a37","html":"<h3 id=\"adding-users-to-acm\" style=\"position:relative;\"><a href=\"#adding-users-to-acm\" aria-label=\"adding users to acm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding users to ACM</h3>\n<p>We use ACM <a href=\"https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.3/html/clusters/managedclustersets#creating-a-managedclusterset\">managed cluster sets</a> to organize our clusters. When a team is looking to create, import, or manage a cluster\nusing the Operate First ACM instance (and thus make it part of the Operate First Cloud), they can do so by creating their\nown <code class=\"language-text\">ManagedClusterSet</code>. Once a team is given admin access to their <code class=\"language-text\">ManagedClusterSet</code>, they can then create and manage\nclusters in this <code class=\"language-text\">ManagedClusterSet</code>, isolated from other clusters within ACM.</p>\n<h3 id=\"steps\" style=\"position:relative;\"><a href=\"#steps\" aria-label=\"steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Steps</h3>\n<ol class=\"pf-c-list\">\n<li>Fork/Clone the <a href=\"https://github.com/operate-first/apps\">apps repo</a></li>\n<li>Navigate to: <code class=\"language-text\">acm/overlays/moc/infra/managedclustersets</code></li>\n<li>Create a new <code class=\"language-text\">clusterset</code> like so:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ManagedClusterSet\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> cluster.open<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>management.io/v1alpha1\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> &lt;YOUR<span class=\"token punctuation\">-</span>CLUSTER<span class=\"token punctuation\">-</span>SET<span class=\"token punctuation\">-</span>NAME<span class=\"token punctuation\">></span> <span class=\"token comment\"># A team/org name is ideal</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Name it <code class=\"language-text\">&lt;YOUR-CLUSTER-SET-NAME&gt;.yaml</code>.</p>\n<ol start=\"4\" class=\"pf-c-list\">\n<li>Add <code class=\"language-text\">&lt;YOUR-CLUSTER-SET-NAME&gt;.yaml</code> <code class=\"language-text\">clusterset</code> to the <code class=\"language-text\">kustomization.yaml</code> to <code class=\"language-text\">acm/overlays/moc/infra/managedclustersets/kustomization.yaml</code>.</li>\n<li>Enable GitOps via ArgoCD for this cluster by adding the <code class=\"language-text\">ManagedClusterSet</code> to the <code class=\"language-text\">Placement</code> found here:  <code class=\"language-text\">acm/overlays/moc/infra/placements/argocd-managed-clusters.yaml</code>.</li>\n</ol>\n<p>Then Create the following <code class=\"language-text\">ManagedClusterSetBinding</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> cluster.open<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>management.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ManagedClusterSetBinding\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> &lt;YOUR<span class=\"token punctuation\">-</span>CLUSTER<span class=\"token punctuation\">-</span>SET<span class=\"token punctuation\">-</span>NAME<span class=\"token punctuation\">></span>\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> argocd\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">clusterSet</span><span class=\"token punctuation\">:</span> &lt;YOUR<span class=\"token punctuation\">-</span>CLUSTER<span class=\"token punctuation\">-</span>SET<span class=\"token punctuation\">-</span>NAME<span class=\"token punctuation\">></span></code></pre></div>\n<p>Name this file <code class=\"language-text\">&lt;YOUR-CLUSTER-SET-NAME&gt;.yaml</code> and add it to <code class=\"language-text\">acm/overlays/moc/infra/managedclustersetbindings</code>.\nAlso add <code class=\"language-text\">&lt;YOUR-CLUSTER-SET-NAME&gt;.yaml</code> to the <code class=\"language-text\">kustomization.yaml</code> within the same path.</p>\n<ol start=\"6\" class=\"pf-c-list\">\n<li>Create the following <code class=\"language-text\">ClusterRoleBinding</code>:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> open<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>management<span class=\"token punctuation\">:</span>managedclusterset<span class=\"token punctuation\">:</span>admin<span class=\"token punctuation\">:</span>&lt;YOUR<span class=\"token punctuation\">-</span>CLUSTER<span class=\"token punctuation\">-</span>SET<span class=\"token punctuation\">-</span>NAME<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Group\n    <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> &lt;YOUR_OCP_GROUP<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> open<span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>management<span class=\"token punctuation\">:</span>managedclusterset<span class=\"token punctuation\">:</span>admin<span class=\"token punctuation\">:</span>&lt;YOUR<span class=\"token punctuation\">-</span>CLUSTER<span class=\"token punctuation\">-</span>SET<span class=\"token punctuation\">-</span>NAME<span class=\"token punctuation\">></span></code></pre></div>\n<p>Replace <code class=\"language-text\">&lt;YOUR-CLUSTER-SET-NAME&gt;</code> with the same name used in (3).\nReplace <code class=\"language-text\">&lt;YOUR_OCP_GROUP&gt;</code> with your teamâ€™s ocp group. You can find your group at <code class=\"language-text\">${APPS_REPO}/cluster-scope/base/user.openshift.io/groups</code>.</p>\n<p>Name this file <code class=\"language-text\">clusterrolebinding.yaml</code>, and add it to this path\n<code class=\"language-text\">cluster-scope/base/rbac.authorization.k8s.io/clusterrolebindings/open-cluster-management:managedclusterset:admin:&lt;YOUR-CLUSTER-SET-NAME&gt;</code>.\nAlso add this <code class=\"language-text\">kustomization.yaml</code> file in the same path:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.config.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Kustomization\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> clusterrolebinding.yaml</code></pre></div>\n<ol start=\"7\" class=\"pf-c-list\">\n<li>\n<p>Add the following line to the <code class=\"language-text\">kustomization.yaml</code> here <code class=\"language-text\">cluster-scope/overlays/prod/moc/infra/kustomization.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> kustomize.config.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Kustomization</code></pre></div>\n</li>\n</ol>\n<p>resources:\n- â€¦\n# Add this line alphabetically, once again replace <YOUR-CLUSTER-SET-NAME> with your ManagedClusterSet name specified in (3)\n- ../../../../base/rbac.authorization.k8s.io/clusterrolebindings/open-cluster-management:managedclusterset:admin:<YOUR-CLUSTER-SET-NAME>\n- â€¦</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">8. Add your group to the _self-provisioners_ `ClusterRoleBinding` by appending this file\n`cluster-scope/overlays/prod/moc/infra/clusterrolebindings/self-provisioners_patch.yaml`:\n\n```yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: self-provisioners\nsubjects:\n...\n    # add your entry here:\n    - apiGroup: rbac.authorization.k8s.io\n      kind: Group\n      name: &lt;YOUR_OCP_GROUP&gt; # Use the same value as in Step 5.</code></pre></div>\n<blockquote>\n<p>Note: This is a workaround for <a href=\"https://github.com/operate-first/support/issues/436\">https://github.com/operate-first/support/issues/436</a></p>\n</blockquote>\n<blockquote>\n<p>Please do not manually create namespaces in the infra cluster, this should be done via filing an issue <a href=\"https://github.com/operate-first/support/issues/new?assignees=first-operator&#x26;labels=kind%2Fonboarding%2Carea%2Fcluster&#x26;template=onboarding_to_cluster.yaml&#x26;title=NEW+PROJECT%3A+%3Cname%3E\">here</a>.</p>\n</blockquote>\n<p>Commit your changes, make a PR, once merged, ArgoCD will deploy these changes and the team should now be able to\ncreate/manage clusters in this ManagedClusterSet.</p>","fields":{"srcLink":"https://github.com/operate-first/apps/blob/master/docs/acm/adding_users_to_acm.md"},"frontmatter":{"title":"","description":null,"extraClasses":null,"banner":null}}},"pageContext":{"id":"6984afa3-8e96-5acc-abe1-7c9703bd9a37"}},"staticQueryHashes":["117426894","1764348645","3000541721","3606484676"]}